{"version":3,"file":"github.mjs","names":["context","github.context"],"sources":["../src/github.ts"],"sourcesContent":["import * as github from '@actions/github'\nimport type { Octokit } from '@octokit/action'\n\nimport type { Comment, MessageContext } from './interfaces'\n\n/**\n * Update the comment of the current PR\n * if lucky and past comment does not exist, create it.\n * if lucky and past comment exists, update it.\n * if not lucky, delete the comment.\n *\n * @param octokit {Octokit} the octokit instance\n * @param prNum {number} the PR number\n * @param userLogin {string} the user login name\n * @param message {MessageContext} the message context\n */\nexport async function updateMessage(\n  octokit: Octokit,\n  prNum: number,\n  userLogin: string,\n  message: MessageContext\n): Promise<void> {\n  const context = github.context\n  const pastComment = await getFirstComment(octokit, prNum, userLogin)\n\n  const { lucky, body } = message\n  if (lucky) {\n    // if there is a comment from the current user and the message is different, update it\n    if (pastComment && pastComment.body !== body) {\n      await octokit.issues.updateComment({\n        ...context.repo,\n        comment_id: pastComment.id,\n        body,\n      })\n    } else {\n      // if there is no comment from the current user, create it\n      await octokit.issues.createComment({\n        ...context.repo,\n        issue_number: prNum,\n        body,\n      })\n    }\n  } else {\n    // if there is a comment from the current user, delete it\n    if (pastComment) {\n      await octokit.issues.deleteComment({\n        ...context.repo,\n        comment_id: pastComment.id,\n      })\n    }\n  }\n}\n\n/**\n * Get the first comment of the current PR by the current user\n * @param octokit {Octokit} the octokit instance\n * @param prNum {number} the PR number\n * @param userLogin {string} the user login name\n * @returns comment id {LastComment}\n */\nasync function getFirstComment(\n  octokit: Octokit,\n  prNum: number,\n  userLogin: string\n): Promise<Comment | null> {\n  const context = github.context\n  // get comments on the PR\n  const comments = await octokit.issues.listComments({\n    ...context.repo,\n    issue_number: prNum,\n  })\n  // find the comment by the current user if it exists\n  for (const comment of comments.data) {\n    if (comment.user?.login === userLogin) {\n      return {\n        id: comment.id,\n        body: comment.body_text || '',\n      }\n    }\n  }\n  return null\n}\n\n/**\n * Get commit ids of the current PR\n * @param octokit {Octokit} the octokit instance\n * @returns commit ids {string[]}\n */\nexport async function getCommitIds(octokit: Octokit): Promise<string[]> {\n  const context = github.context\n  const commits = await octokit.pulls.listCommits({\n    ...context.repo,\n    pull_number: context.issue.number,\n  })\n  return commits.data.map((commit: { sha: string }) => commit.sha)\n}\n\n/**\n * Get login name of the current user\n * By default, this returns `github-actions[bot]`\n * @param octokit {Octokit} the octokit instance\n * @returns user login {string}\n */\nexport async function getUserLogin(octokit: Octokit) {\n  interface Result {\n    viewer: {\n      login: string\n    }\n  }\n  const resp: Result = await octokit.graphql(`\nquery {\n  viewer {\n    login\n  }\n}`)\n  return resp.viewer.login\n}\n"],"mappings":"0CAgBA,eAAsB,EACpB,EACA,EACA,EACA,EACe,CACf,IAAMA,EAAUC,EACV,EAAc,MAAM,EAAgB,EAAS,EAAO,EAAU,CAE9D,CAAE,QAAO,QAAS,EACpB,EAEE,GAAe,EAAY,OAAS,EACtC,MAAM,EAAQ,OAAO,cAAc,CACjC,GAAGD,EAAQ,KACX,WAAY,EAAY,GACxB,OACD,CAAC,CAGF,MAAM,EAAQ,OAAO,cAAc,CACjC,GAAGA,EAAQ,KACX,aAAc,EACd,OACD,CAAC,CAIA,GACF,MAAM,EAAQ,OAAO,cAAc,CACjC,GAAGA,EAAQ,KACX,WAAY,EAAY,GACzB,CAAC,CAYR,eAAe,EACb,EACA,EACA,EACyB,CACzB,IAAMA,EAAUC,EAEV,EAAW,MAAM,EAAQ,OAAO,aAAa,CACjD,GAAGD,EAAQ,KACX,aAAc,EACf,CAAC,CAEF,IAAK,IAAM,KAAW,EAAS,KAC7B,GAAI,EAAQ,MAAM,QAAU,EAC1B,MAAO,CACL,GAAI,EAAQ,GACZ,KAAM,EAAQ,WAAa,GAC5B,CAGL,OAAO,KAQT,eAAsB,EAAa,EAAqC,CACtE,IAAMA,EAAUC,EAKhB,OAJgB,MAAM,EAAQ,MAAM,YAAY,CAC9C,GAAGD,EAAQ,KACX,YAAaA,EAAQ,MAAM,OAC5B,CAAC,EACa,KAAK,IAAK,GAA4B,EAAO,IAAI,CASlE,eAAsB,EAAa,EAAkB,CAYnD,OANqB,MAAM,EAAQ,QAAQ;;;;;GAK1C,EACW,OAAO"}