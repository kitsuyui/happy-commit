{"version":3,"file":"message_builder.mjs","names":["Mustache"],"sources":["../src/message_builder.ts"],"sourcesContent":["import Mustache from 'mustache'\n\nimport type {\n  LuckyJudgeContext,\n  MessageContext,\n  MessageForRule,\n} from './interfaces'\nimport { Rules, type RulesKey } from './rules'\n\n/**\n * MessageBuilder is a class to build a message for a pull request\n *\n * It has two kinds of rules, one is for pull request, the other is for commit.\n */\nclass MessageBuilder {\n  rules: MessageForRule[]\n  baseTemplate: string\n\n  constructor(rules: MessageForRule[], baseTemplate: string) {\n    this.rules = rules\n    this.baseTemplate = baseTemplate\n  }\n\n  prRules(): MessageForRule[] {\n    return this.rules.filter((rule) => rule.kind === 'pr')\n  }\n\n  commitRules(): MessageForRule[] {\n    return this.rules.filter((rule) => rule.kind === 'commit')\n  }\n\n  build(context: LuckyJudgeContext): MessageContext {\n    const { commitIds, prNum } = context\n    const messages = []\n    let lucky = false\n\n    for (const { rule, message } of this.prRules()) {\n      const matched = prNum.toString().match(rule)\n      if (matched) {\n        const builtMessage = Mustache.render(message, { matched, prNum })\n        messages.push(builtMessage)\n        lucky = true\n      }\n    }\n\n    for (const { rule, message } of this.commitRules()) {\n      for (const commitId of commitIds) {\n        const matched = commitId.match(rule)\n        if (matched) {\n          const builtMessage = Mustache.render(message, { matched, commitId })\n          messages.push(builtMessage)\n          lucky = true\n        }\n      }\n    }\n\n    const body = Mustache.render(this.baseTemplate, { messages })\n    return {\n      lucky,\n      body,\n    }\n  }\n}\n\nconst defaultRules = {\n  pr_reaches_contain_only_one_nonzero_digit: true,\n  pr_reaches_power_of_2: true,\n  pr_reaches_777: true,\n  commit_hits_777: true,\n  commit_hits_same_numbers: true,\n  commit_hits_123: true,\n  commit_hits_hexspeak: true,\n  commit_hits_666: true,\n} as { [key in RulesKey]: boolean }\n\n/**\n * CustomMessageBuilder is a class to build a message for a pull request with custom rules\n */\nexport class CustomMessageBuilder {\n  builder: MessageBuilder\n\n  constructor(\n    message: string,\n    overrides: { [key in RulesKey]?: boolean } = {},\n    additionalRules: MessageForRule[] = []\n  ) {\n    const rules: MessageForRule[] = [...additionalRules].concat(\n      Object.entries(Rules)\n        .filter(([key]) => {\n          if (key in overrides) {\n            return overrides[key as RulesKey]\n          }\n          return defaultRules[key as RulesKey]\n        })\n        .map(([, value]) => value)\n    )\n    this.builder = new MessageBuilder(rules, message)\n  }\n\n  build(context: LuckyJudgeContext): MessageContext {\n    return this.builder.build(context)\n  }\n}\n"],"mappings":"2GAcA,IAAM,EAAN,KAAqB,CACnB,MACA,aAEA,YAAY,EAAyB,EAAsB,CACzD,KAAK,MAAQ,EACb,KAAK,aAAe,EAGtB,SAA4B,CAC1B,OAAO,KAAK,MAAM,OAAQ,GAAS,EAAK,OAAS,KAAK,CAGxD,aAAgC,CAC9B,OAAO,KAAK,MAAM,OAAQ,GAAS,EAAK,OAAS,SAAS,CAG5D,MAAM,EAA4C,CAChD,GAAM,CAAE,YAAW,SAAU,EACvB,EAAW,EAAE,CACf,EAAQ,GAEZ,IAAK,GAAM,CAAE,OAAM,aAAa,KAAK,SAAS,CAAE,CAC9C,IAAM,EAAU,EAAM,UAAU,CAAC,MAAM,EAAK,CAC5C,GAAI,EAAS,CACX,IAAM,EAAeA,EAAS,OAAO,EAAS,CAAE,UAAS,QAAO,CAAC,CACjE,EAAS,KAAK,EAAa,CAC3B,EAAQ,IAIZ,IAAK,GAAM,CAAE,OAAM,aAAa,KAAK,aAAa,CAChD,IAAK,IAAM,KAAY,EAAW,CAChC,IAAM,EAAU,EAAS,MAAM,EAAK,CACpC,GAAI,EAAS,CACX,IAAM,EAAeA,EAAS,OAAO,EAAS,CAAE,UAAS,WAAU,CAAC,CACpE,EAAS,KAAK,EAAa,CAC3B,EAAQ,IAKd,IAAM,EAAOA,EAAS,OAAO,KAAK,aAAc,CAAE,WAAU,CAAC,CAC7D,MAAO,CACL,QACA,OACD,GAIL,MAAM,EAAe,CACnB,0CAA2C,GAC3C,sBAAuB,GACvB,eAAgB,GAChB,gBAAiB,GACjB,yBAA0B,GAC1B,gBAAiB,GACjB,qBAAsB,GACtB,gBAAiB,GAClB,CAKD,IAAa,EAAb,KAAkC,CAChC,QAEA,YACE,EACA,EAA6C,EAAE,CAC/C,EAAoC,EAAE,CACtC,CAWA,KAAK,QAAU,IAAI,EAVa,CAAC,GAAG,EAAgB,CAAC,OACnD,OAAO,QAAQ,EAAM,CAClB,QAAQ,CAAC,KACJ,KAAO,EACF,EAAU,GAEZ,EAAa,GACpB,CACD,KAAK,EAAG,KAAW,EAAM,CAC7B,CACwC,EAAQ,CAGnD,MAAM,EAA4C,CAChD,OAAO,KAAK,QAAQ,MAAM,EAAQ"}